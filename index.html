<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HUNTER SYSTEM | Solo Leveling</title>
    <meta name="description" content="Advanced RPG Fitness Tracking System">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        system: {
                            bg: "#02040a",
                            panel: "rgba(12, 18, 30, 0.9)",
                            border: "rgba(56, 189, 248, 0.3)",
                            accent: "#0ea5e9",
                            accentGlow: "rgba(14, 165, 233, 0.5)",
                            success: "#10b981",
                            danger: "#ef4444",
                            warning: "#f59e0b",
                            text: "#e2e8f0",
                            dim: "#64748b"
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        tech: ['"Rajdhani"', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scan': 'scan 4s linear infinite',
                        'boot': 'bootUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        scan: {
                            '0%': { top: '0%', opacity: '0' },
                            '15%': { opacity: '1' },
                            '85%': { opacity: '1' },
                            '100%': { top: '100%', opacity: '0' },
                        },
                        bootUp: {
                            '0%': { opacity: '0', filter: 'blur(10px)', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', filter: 'blur(0)', transform: 'scale(1)' }
                        }
                    },
                    backgroundImage: {
                        'grid-pattern': "linear-gradient(rgba(14, 165, 233, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(14, 165, 233, 0.03) 1px, transparent 1px)"
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #02040a;
            background-image: radial-gradient(circle at 50% 0%, #0c1829 0%, #02040a 80%);
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        .bg-grid {
            background-size: 40px 40px;
            background-image: 
                linear-gradient(to right, rgba(14, 165, 233, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(14, 165, 233, 0.05) 1px, transparent 1px);
            mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
        }

        .tech-panel {
            background: rgba(10, 15, 26, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(14, 165, 233, 0.15);
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .tech-panel::before, .tech-panel::after {
            content: ''; position: absolute; width: 8px; height: 8px; transition: all 0.3s ease; pointer-events: none;
        }
        .tech-panel::before { top: -1px; left: -1px; border-top: 2px solid rgba(14, 165, 233, 0.6); border-left: 2px solid rgba(14, 165, 233, 0.6); }
        .tech-panel::after { bottom: -1px; right: -1px; border-bottom: 2px solid rgba(14, 165, 233, 0.6); border-right: 2px solid rgba(14, 165, 233, 0.6); }
        .tech-panel:hover { border-color: rgba(14, 165, 233, 0.3); box-shadow: 0 0 15px rgba(14, 165, 233, 0.1); }

        .text-glow { text-shadow: 0 0 10px rgba(14, 165, 233, 0.6); }
        .text-glow-sm { text-shadow: 0 0 5px rgba(14, 165, 233, 0.4); }

        .tech-progress-bg { background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.2); position: relative; overflow: hidden; }
        .tech-progress-fill { background: linear-gradient(90deg, #0284c7, #38bdf8); box-shadow: 0 0 15px rgba(56, 189, 248, 0.5); height: 100%; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); }
        .tech-progress-fill::after { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%); transform: skewX(-20deg) translateX(-150%); animation: shimmer 2s infinite; }
        
        @keyframes shimmer { 100% { transform: skewX(-20deg) translateX(150%); } }

        .nav-item { position: relative; transition: all 0.3s ease; opacity: 0.6; }
        .nav-item.active { opacity: 1; color: #38bdf8; text-shadow: 0 0 8px rgba(56, 189, 248, 0.6); }
        .nav-item.active::before { content: ''; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 40%; height: 2px; background: #38bdf8; box-shadow: 0 0 8px #38bdf8; }

        .btn-tech { background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.4); color: #38bdf8; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; font-family: 'Rajdhani', sans-serif; font-weight: 700; position: relative; overflow: hidden; }
        .btn-tech:hover { background: rgba(14, 165, 233, 0.2); border-color: #38bdf8; box-shadow: 0 0 15px rgba(14, 165, 233, 0.3); transform: translateY(-1px); }
        .btn-tech.active-mode { background: rgba(14, 165, 233, 0.3); border-color: #38bdf8; box-shadow: 0 0 10px rgba(14, 165, 233, 0.4); color: white; }
        .btn-tech-danger { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; }
        .btn-tech-danger:hover { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }

        .scanline { width: 100%; height: 3px; background: rgba(56, 189, 248, 0.7); box-shadow: 0 0 15px rgba(56, 189, 248, 0.9); position: absolute; z-index: 10; pointer-events: none; animation: scan 3s linear infinite; }
        
        .input-tech { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(56, 189, 248, 0.2); color: white; padding: 10px; width: 100%; font-family: 'Rajdhani', sans-serif; transition: all 0.3s; }
        .input-tech:focus { border-color: #0ea5e9; outline: none; box-shadow: 0 0 10px rgba(14, 165, 233, 0.2); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #02040a; }
        ::-webkit-scrollbar-thumb { background: #0f4c75; border-radius: 2px; }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans selection:bg-system-accent selection:text-white relative">
    
    <div class="fixed inset-0 bg-grid pointer-events-none z-0"></div>
    <audio id="sfx-select" src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQQAAAAAAA=="></audio>

    <header id="main-header" class="fixed top-0 w-full z-50 bg-[#02040a]/90 backdrop-blur-md border-b border-system-border hidden">
        <div class="container mx-auto px-5 py-3 flex justify-between items-center h-16">
            <div class="flex flex-col">
                <div class="flex items-center gap-1.5">
                    <div class="w-1.5 h-1.5 bg-system-accent rounded-full animate-pulse"></div>
                    <h1 class="text-xs text-system-accent font-tech font-bold tracking-[0.2em] uppercase text-glow-sm">
                        System_Online
                    </h1>
                </div>
                <div class="text-[10px] font-medium tracking-wide text-system-dim mt-0.5">
                    PLAYER: <span id="header-name" class="text-white font-bold font-tech text-base tracking-normal ml-1">JIN-WOO</span>
                </div>
            </div>
            
            <div class="flex items-center gap-5">
                <div id="sp-indicator" class="hidden cursor-pointer group" onclick="app.router('dashboard'); app.openStatModal()">
                    <div class="bg-system-danger/10 border border-system-danger/40 text-system-danger px-3 py-1 rounded text-[10px] font-bold font-tech flex items-center gap-2 shadow-[0_0_10px_rgba(239,68,68,0.15)] group-hover:bg-system-danger/20 transition-all">
                        <i class="fas fa-exclamation-circle animate-bounce"></i>
                        <span id="sp-count" class="text-sm">0</span> <span class="tracking-widest">SP</span>
                    </div>
                </div>
                <div class="text-right">
                    <div id="header-rank" class="text-3xl font-bold italic leading-none text-white text-glow font-tech">E</div>
                    <div class="text-[8px] font-bold text-system-dim uppercase tracking-[0.25em]">RANK</div>
                </div>
            </div>
        </div>
    </header>

    <main id="app-container" class="flex-1 container mx-auto px-4 pt-6 relative z-10 max-w-2xl flex flex-col justify-center min-h-screen">
        <!-- Views injected here -->
    </main>

    <nav id="main-nav" class="fixed bottom-0 w-full z-50 bg-[#02040a]/95 backdrop-blur-xl border-t border-system-border pb-safe hidden">
        <div class="flex justify-around items-center h-20 max-w-2xl mx-auto px-2">
            <button onclick="app.playSound('click'); app.router('dashboard')" class="nav-item flex flex-col items-center justify-center w-full h-full" data-page="dashboard">
                <i class="fas fa-id-card text-lg mb-1.5"></i>
                <span class="text-[10px] font-bold font-tech uppercase tracking-widest">Status</span>
            </button>
            <button onclick="app.playSound('click'); app.router('quests')" class="nav-item flex flex-col items-center justify-center w-full h-full" data-page="quests">
                <i class="fas fa-scroll text-lg mb-1.5"></i>
                <span class="text-[10px] font-bold font-tech uppercase tracking-widest">Quests</span>
            </button>
            <button onclick="app.playSound('click'); app.router('training')" class="nav-item flex flex-col items-center justify-center w-full h-full" data-page="training">
                <i class="fas fa-dumbbell text-lg mb-1.5"></i>
                <span class="text-[10px] font-bold font-tech uppercase tracking-widest">Train</span>
            </button>
            <button onclick="app.playSound('click'); app.router('logs')" class="nav-item flex flex-col items-center justify-center w-full h-full" data-page="logs">
                <i class="fas fa-history text-lg mb-1.5"></i>
                <span class="text-[10px] font-bold font-tech uppercase tracking-widest">Logs</span>
            </button>
        </div>
    </nav>

    <div id="modal-overlay" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center px-4 opacity-0 transition-opacity duration-300">
        <div id="modal-content" class="w-full max-w-sm transform scale-95 transition-transform duration-300"></div>
    </div>

    <div id="toast-container" class="fixed top-24 left-0 right-0 z-[70] pointer-events-none flex flex-col items-center gap-3 px-4"></div>

    <script>
        const STORAGE_KEY = 'hunter_system_vftf_save_v8_login';

        // --- Game State ---
        const gameState = {
            setupComplete: false,
            player: {
                name: "Player",
                height: 0,
                weight: 0,
                level: 1,
                exp: 0,
                expToNext: 100,
                hp: 100,
                rank: "E",
                stats: { str: 10, agi: 10, vit: 10, int: 10, per: 10, luk: 10 },
                statPoints: 0,
                lastLogin: null
            },
            quests: [
                { id: 'q_push', title: "Strength: Push-Ups", desc: "Standard Push-ups", type: "DAILY", goal: 100, current: 0, reward: 200, completed: false, stat: "str", mode: 'pushup' },
                { id: 'q_squat', title: "Vitality: Squats", desc: "Standard Squats", type: "DAILY", goal: 100, current: 0, reward: 200, completed: false, stat: "vit", mode: 'squat' },
                { id: 'q_pull', title: "Strength: Pull-Ups", desc: "Upper Body Strength", type: "DAILY", goal: 50, current: 0, reward: 300, completed: false, stat: "str", mode: 'pullup' },
                { id: 'q_lunge', title: "Agility: Lunges", desc: "Lower Body Stability", type: "DAILY", goal: 50, current: 0, reward: 200, completed: false, stat: "agi", mode: 'lunge' },
                { id: 'q_hspu', title: "Special: Handstand", desc: "Advanced Shoulder Press", type: "SPECIAL", goal: 20, current: 0, reward: 500, completed: false, stat: "str", mode: 'hspu' }
            ],
            logs: [],
            trainingMode: 'pushup',
            activePage: 'login'
        };

        const app = {
            audioCtx: null,
            training: { active: false, mode: 'pushup', count: 0, stage: 'start', lastTime: 0 },

            init() {
                this.loadState();
                
                document.body.addEventListener('click', () => {
                    if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }, { once: true });

                if (!gameState.setupComplete) {
                    this.router('login');
                } else {
                    this.checkDailyReset();
                    this.router(gameState.activePage === 'login' ? 'dashboard' : gameState.activePage);
                }

                setInterval(() => this.checkCooldowns(), 1000);
            },

            saveState() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
                this.updateGlobalHUD();
            },

            loadState() {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    gameState.setupComplete = parsed.setupComplete || false;
                    gameState.player = { ...gameState.player, ...parsed.player };
                    delete gameState.player.mp; 
                    if (!gameState.player.stats.luk) gameState.player.stats.luk = 10;
                    if (parsed.quests) {
                        parsed.quests.forEach(pq => {
                            const existing = gameState.quests.find(q => q.id === pq.id);
                            if (existing) { existing.current = pq.current; existing.completed = pq.completed; }
                        });
                    }
                    gameState.logs = parsed.logs || [];
                }
            },

            checkDailyReset() {
                const today = new Date().toDateString();
                if (gameState.player.lastLogin !== today) {
                    gameState.quests.forEach(q => { q.current = 0; q.completed = false; });
                    gameState.player.lastLogin = today;
                    this.saveState();
                }
            },

            resetSystem() {
                if(confirm("WARNING: INITIATE SYSTEM RESET? ALL HUNTER DATA WILL BE ERASED.")) {
                    localStorage.removeItem(STORAGE_KEY);
                    location.reload();
                }
            },

            router(page) {
                // Determine layout mode
                const header = document.getElementById('main-header');
                const nav = document.getElementById('main-nav');
                const container = document.getElementById('app-container');

                if (page === 'login') {
                    header.classList.add('hidden');
                    nav.classList.add('hidden');
                    container.classList.remove('pt-24', 'pb-28');
                    container.classList.add('pt-6');
                } else {
                    header.classList.remove('hidden');
                    nav.classList.remove('hidden');
                    container.classList.add('pt-24', 'pb-28');
                    container.classList.remove('pt-6');
                }

                gameState.activePage = page;
                document.querySelectorAll('.nav-item').forEach(btn => btn.classList.toggle('active', btn.dataset.page === page));
                
                container.innerHTML = ''; 
                container.classList.remove('animate-boot');
                void container.offsetWidth; 
                container.classList.add('animate-boot');

                switch(page) {
                    case 'login': this.renderLogin(container); break;
                    case 'dashboard': this.renderDashboard(container); break;
                    case 'quests': this.renderQuests(container); break;
                    case 'training': this.renderTraining(container); break;
                    case 'logs': this.renderLogs(container); break;
                }
                
                if (page !== 'training') this.stopCamera();
                this.saveState();
            },

            updateGlobalHUD() {
                document.getElementById('header-name').innerText = gameState.player.name.toUpperCase();
                document.getElementById('header-rank').innerText = gameState.player.rank;
                const spEl = document.getElementById('sp-indicator');
                const spCount = document.getElementById('sp-count');
                if (gameState.player.statPoints > 0) {
                    spEl.classList.remove('hidden');
                    spCount.innerText = gameState.player.statPoints;
                } else {
                    spEl.classList.add('hidden');
                }
            },

            addLog(type, message, details) {
                const entry = {
                    id: Date.now(), type, message, details,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    date: new Date().toLocaleDateString()
                };
                gameState.logs.unshift(entry);
                if (gameState.logs.length > 50) gameState.logs.pop();
                this.saveState();
            },

            // --- Renderers ---
            renderLogin(container) {
                container.innerHTML = `
                    <div class="tech-panel p-8 rounded-lg border border-system-accent/30 max-w-sm mx-auto w-full relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-system-accent shadow-[0_0_15px_#0ea5e9]"></div>
                        
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-tech font-bold text-white text-glow tracking-[0.2em] mb-2">SYSTEM_INIT</h1>
                            <p class="text-[10px] text-system-dim uppercase tracking-widest">Player Registration Required</p>
                        </div>

                        <form onsubmit="app.handleLogin(event)" class="space-y-6">
                            <div>
                                <label class="block text-[10px] font-bold text-system-accent uppercase tracking-widest mb-1.5">Player Name</label>
                                <input type="text" id="input-name" required class="input-tech rounded-sm bg-black/50 border-system-border focus:border-system-accent" placeholder="Enter Name">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[10px] font-bold text-system-accent uppercase tracking-widest mb-1.5">Height (cm)</label>
                                    <input type="number" id="input-height" required class="input-tech rounded-sm bg-black/50 border-system-border focus:border-system-accent" placeholder="180">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-system-accent uppercase tracking-widest mb-1.5">Weight (kg)</label>
                                    <input type="number" id="input-weight" required class="input-tech rounded-sm bg-black/50 border-system-border focus:border-system-accent" placeholder="75">
                                </div>
                            </div>

                            <button type="submit" class="w-full btn-tech py-4 mt-4 text-sm font-bold tracking-[0.2em] hover:bg-system-accent hover:text-white transition-all group relative overflow-hidden">
                                <span class="relative z-10">AWAKEN</span>
                                <div class="absolute inset-0 bg-system-accent/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                            </button>
                        </form>
                        
                        <div class="mt-6 text-center">
                            <p class="text-[8px] text-system-dim/50 font-mono">ID: UNKNOWN // STATUS: PENDING</p>
                        </div>
                    </div>
                `;
            },

            handleLogin(e) {
                e.preventDefault();
                const name = document.getElementById('input-name').value;
                const height = document.getElementById('input-height').value;
                const weight = document.getElementById('input-weight').value;

                if(name && height && weight) {
                    gameState.player.name = name;
                    gameState.player.height = height;
                    gameState.player.weight = weight;
                    gameState.setupComplete = true;
                    
                    this.playSound('levelup');
                    this.addLog('SYSTEM', 'REGISTRATION COMPLETE', `Welcome, Player ${name}.`);
                    
                    // Show a brief "Awakening" animation toast before routing
                    const container = document.getElementById('app-container');
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full animate-pulse">
                            <div class="text-4xl text-system-accent font-tech font-bold text-glow mb-4">WELCOME</div>
                            <div class="text-sm text-white font-mono tracking-widest">INITIALIZING HUNTER INTERFACE...</div>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        this.saveState();
                        this.router('dashboard');
                    }, 2000);
                }
            },

            renderDashboard(container) {
                const p = gameState.player;
                const progress = (p.exp / p.expToNext) * 100;
                const stats = p.stats;
                const maxVal = Math.max(20, ...Object.values(stats));
                const polyPoints = this.getHexPoints(stats, maxVal);

                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="tech-panel p-6 rounded-lg">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <div class="text-[10px] text-system-accent font-tech mb-1 uppercase tracking-[0.2em] font-bold">Job Class</div>
                                    <div class="text-2xl font-bold text-white tracking-wide font-tech text-glow">SHADOW MONARCH</div>
                                    <div class="flex items-center gap-2 mt-2">
                                        <div class="bg-system-accent/10 border border-system-accent/30 px-2 py-0.5 rounded text-[10px] text-system-accent uppercase font-bold tracking-wider">Title: Wolf Slayer</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-system-dim font-tech mb-0.5 uppercase tracking-widest">Level</div>
                                    <div class="text-5xl font-bold text-white text-glow font-tech italic leading-none">${p.level}</div>
                                </div>
                            </div>
                            <div class="mb-5">
                                <div class="flex justify-between text-[9px] font-bold font-tech tracking-wider mb-1">
                                    <span class="text-system-success">HP // HEALTH</span>
                                    <span class="text-white">${p.hp} <span class="text-gray-500">/</span> 100</span>
                                </div>
                                <div class="h-2 bg-gray-900/50 rounded-sm overflow-hidden border border-white/5">
                                    <div class="h-full bg-system-success shadow-[0_0_10px_rgba(16,185,129,0.5)]" style="width: ${p.hp}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-[9px] font-bold font-tech tracking-wider mb-1">
                                    <span class="text-system-dim">EXP PROGRESS</span>
                                    <span class="text-white">${Math.floor(p.exp)} <span class="text-gray-500">/</span> ${p.expToNext}</span>
                                </div>
                                <div class="tech-progress-bg h-2 rounded-sm">
                                    <div class="tech-progress-fill" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="tech-panel rounded-lg overflow-hidden flex flex-col md:flex-row">
                             <div class="p-6 flex-1 flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-system-border/30 bg-[#060a15]/50">
                                 <h3 class="w-full text-[10px] font-tech text-system-accent mb-4 border-b border-white/5 pb-2 uppercase tracking-[0.2em] text-center font-bold">Parameter_Graph</h3>
                                 <div class="relative w-64 h-64">
                                    <svg viewBox="0 0 100 100" class="w-full h-full overflow-visible drop-shadow-[0_0_20px_rgba(14,165,233,0.2)]">
                                        ${this.getHexGrid()}
                                        ${this.getHexAxes()}
                                        <polygon points="${polyPoints}" fill="rgba(14, 165, 233, 0.2)" stroke="#38bdf8" stroke-width="1" stroke-linejoin="round">
                                            <animate attributeName="opacity" values="0.7;1;0.7" dur="3s" repeatCount="indefinite" />
                                        </polygon>
                                        ${this.getHexDots(stats, maxVal)}
                                    </svg>
                                    <div class="absolute inset-0 pointer-events-none">
                                        <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-4 text-[10px] font-bold text-system-accent font-tech">STR</div>
                                        <div class="absolute top-[25%] right-0 translate-x-3 text-[10px] font-bold text-system-dim font-tech">VIT</div>
                                        <div class="absolute bottom-[25%] right-0 translate-x-3 text-[10px] font-bold text-system-dim font-tech">LUK</div>
                                        <div class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-4 text-[10px] font-bold text-system-dim font-tech">INT</div>
                                        <div class="absolute bottom-[25%] left-0 -translate-x-3 text-[10px] font-bold text-system-dim font-tech">PER</div>
                                        <div class="absolute top-[25%] left-0 -translate-x-3 text-[10px] font-bold text-system-dim font-tech">AGI</div>
                                    </div>
                                </div>
                             </div>
                             <div class="p-6 flex-1 flex flex-col justify-center">
                                <h3 class="text-[10px] font-tech text-system-dim mb-4 border-b border-white/5 pb-2 uppercase tracking-[0.2em] font-bold">Ability_Status</h3>
                                <div class="grid grid-cols-2 gap-x-8 gap-y-4">
                                    ${Object.entries(p.stats).map(([key, val]) => `
                                        <div class="flex justify-between items-end border-b border-white/5 pb-1 group hover:border-system-accent/30 transition-colors">
                                            <span class="text-[10px] uppercase font-bold text-system-dim group-hover:text-white transition-colors font-tech tracking-wider">${key}</span>
                                            <span class="text-base font-tech font-bold text-white tracking-widest">${val}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-8">
                                    <button onclick="app.playSound('click'); app.openStatModal()" class="btn-tech w-full py-3 rounded text-[10px]">
                                        ${p.statPoints > 0 ? `<i class="fas fa-plus-circle mr-2 animate-pulse"></i>Allocate Points (${p.statPoints})` : `<i class="fas fa-cog mr-2"></i>Manage Attributes`}
                                    </button>
                                </div>
                             </div>
                        </div>
                    </div>
                `;
            },

            renderLogs(container) {
                container.innerHTML = `
                    <div class="space-y-4 animate-boot">
                        <div class="flex justify-between items-end mb-4 px-1 border-b-2 border-system-accent/30 pb-2">
                            <h2 class="text-xs font-tech text-system-accent uppercase tracking-[0.2em] font-bold">System_Logs</h2>
                            <span class="text-[9px] text-system-dim font-bold font-tech tracking-wider">TOTAL: ${gameState.logs.length}</span>
                        </div>
                        <div class="space-y-3 mb-8">
                            ${gameState.logs.length === 0 ? `<div class="text-center py-8 text-system-dim text-xs font-tech">NO RECORDS FOUND</div>` : 
                                gameState.logs.map(log => {
                                    let icon = 'fa-info-circle', color = 'text-system-accent', border = 'border-l-system-accent/30';
                                    if(log.type === 'QUEST') { icon = 'fa-check-circle'; color = 'text-system-success'; border = 'border-l-system-success'; }
                                    if(log.type === 'LEVEL') { icon = 'fa-arrow-up'; color = 'text-system-warning'; border = 'border-l-system-warning'; }
                                    if(log.type === 'GROWTH') { icon = 'fa-chart-line'; color = 'text-system-accent'; border = 'border-l-system-accent'; }
                                    if(log.type === 'TRAIN') { icon = 'fa-dumbbell'; color = 'text-white'; border = 'border-l-white/30'; }
                                    if(log.type === 'SYSTEM') { icon = 'fa-power-off'; color = 'text-white'; border = 'border-l-white'; }
                                    return `
                                    <div class="tech-panel p-3 rounded-sm flex items-start gap-3 border-l-2 ${border} hover:bg-white/5 transition-colors">
                                        <div class="mt-0.5 ${color} text-sm"><i class="fas ${icon}"></i></div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-start">
                                                <h4 class="text-[10px] font-bold text-white uppercase tracking-wide font-tech">${log.message}</h4>
                                                <span class="text-[8px] text-system-dim font-mono">${log.date} ${log.time}</span>
                                            </div>
                                            <p class="text-[9px] text-system-dim mt-0.5 font-medium truncate font-mono">${log.details}</p>
                                        </div>
                                    </div>`
                                }).join('')}
                        </div>
                        <button onclick="app.resetSystem()" class="w-full btn-tech-danger py-4 rounded-sm font-bold text-xs tracking-widest"><i class="fas fa-trash-alt mr-2"></i>SYSTEM RESET</button>
                    </div>
                `;
            },

            renderQuests(container) {
                container.innerHTML = `
                    <div class="space-y-5">
                        <div class="flex justify-between items-end mb-4 px-1 border-b-2 border-system-accent/30 pb-2">
                            <h2 class="text-xs font-tech text-system-accent uppercase tracking-[0.2em] font-bold">Daily_Quests</h2>
                            <span class="text-[9px] text-system-dim font-bold font-tech tracking-wider">RESET: 00:00:00</span>
                        </div>
                        ${gameState.quests.map(q => {
                            const pct = Math.min(100, (q.current / q.goal) * 100);
                            return `
                            <div class="tech-panel p-5 rounded-lg group transition-all duration-300 ${q.completed ? 'opacity-60 grayscale hover:opacity-100 hover:grayscale-0' : 'hover:border-system-accent/50'}">
                                ${q.completed ? '<div class="absolute inset-0 flex items-center justify-center z-20 pointer-events-none"><div class="bg-system-success/10 backdrop-blur-sm border border-system-success/50 text-system-success font-black text-xl -rotate-12 px-6 py-3 rounded uppercase tracking-widest text-glow shadow-[0_0_20px_rgba(16,185,129,0.3)]">Cleared</div></div>' : ''}
                                <div class="flex justify-between items-start mb-4 relative z-10">
                                    <div>
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="bg-system-danger/10 text-system-danger border border-system-danger/30 text-[9px] font-bold px-2 py-0.5 rounded-sm uppercase tracking-wide font-tech">${q.type}</span>
                                            <span class="text-[9px] font-tech text-system-dim uppercase font-bold tracking-wider">[${q.stat.toUpperCase()}]</span>
                                        </div>
                                        <h3 class="font-bold text-base text-white group-hover:text-system-accent transition-colors font-tech tracking-wide">${q.title}</h3>
                                        <p class="text-[10px] text-gray-400 mt-0.5 font-medium">${q.desc}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-tech font-bold text-system-accent bg-system-accent/5 px-2 py-1 rounded border border-system-accent/10">
                                            ${q.current} <span class="text-gray-500 text-[10px]">/</span> ${q.goal}
                                        </div>
                                    </div>
                                </div>
                                <div class="relative z-10 mt-2 mb-4">
                                    <div class="tech-progress-bg h-1.5 rounded-sm">
                                        <div class="tech-progress-fill" style="width: ${pct}%"></div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center relative z-10">
                                    <div class="text-[10px] font-bold text-system-warning flex items-center gap-1.5 bg-system-warning/5 px-2 py-1 rounded border border-system-warning/10 font-tech tracking-wide">
                                        <i class="fas fa-coins text-[9px]"></i> <span>REWARD: ${q.reward} EXP</span>
                                    </div>
                                    ${!q.completed ? `<span class="text-[9px] font-bold font-tech text-system-accent opacity-70 uppercase animate-pulse"><i class="fas fa-link mr-1"></i> Auto-Sync Active</span>` : ''}
                                </div>
                            </div>
                        `}).join('')}
                        <div class="tech-panel p-4 rounded-lg border-system-danger/40 mt-8 bg-system-danger/5 flex items-start gap-4">
                            <div class="text-2xl text-system-danger animate-pulse mt-1"><i class="fas fa-exclamation-triangle"></i></div>
                            <div>
                                <h3 class="text-system-danger font-tech text-xs uppercase mb-1 font-bold tracking-wider text-glow-danger">Penalty Warning</h3>
                                <p class="text-[10px] text-gray-400 leading-relaxed font-medium">Failure to complete daily quests results in automatic transport to the <span class="text-system-danger font-bold">Penalty Zone</span> for 4 hours.</p>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderTraining(container) {
                container.innerHTML = `
                    <div class="flex flex-col h-full animate-boot">
                        <h2 class="text-xs font-tech text-system-accent uppercase tracking-[0.2em] border-b-2 border-system-accent/30 pb-2 mb-6 font-bold">Neural_Feedback_Interface</h2>
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button onclick="app.setTrainingMode('pushup')" class="flex-1 btn-tech py-2 text-[9px] ${gameState.trainingMode === 'pushup' ? 'active-mode' : ''}"><i class="fas fa-arrow-down block text-xs mb-1"></i>Push</button>
                            <button onclick="app.setTrainingMode('pullup')" class="flex-1 btn-tech py-2 text-[9px] ${gameState.trainingMode === 'pullup' ? 'active-mode' : ''}"><i class="fas fa-arrow-up block text-xs mb-1"></i>Pull</button>
                            <button onclick="app.setTrainingMode('squat')" class="flex-1 btn-tech py-2 text-[9px] ${gameState.trainingMode === 'squat' ? 'active-mode' : ''}"><i class="fas fa-chair block text-xs mb-1"></i>Squat</button>
                            <button onclick="app.setTrainingMode('lunge')" class="flex-1 btn-tech py-2 text-[9px] ${gameState.trainingMode === 'lunge' ? 'active-mode' : ''}"><i class="fas fa-walking block text-xs mb-1"></i>Lunge</button>
                            <button onclick="app.setTrainingMode('hspu')" class="flex-1 btn-tech py-2 text-[9px] ${gameState.trainingMode === 'hspu' ? 'active-mode' : ''}"><i class="fas fa-hand-rock block text-xs mb-1"></i>HSPU</button>
                        </div>
                        <div class="relative w-full aspect-[3/4] md:aspect-video bg-black rounded-lg overflow-hidden border border-system-accent/30 shadow-[0_0_30px_rgba(14,165,233,0.1)] group">
                            <video id="video-feed" class="absolute inset-0 w-full h-full object-cover -scale-x-100 opacity-50 group-hover:opacity-100 transition-opacity duration-500" playsinline></video>
                            <canvas id="pose-canvas" class="absolute inset-0 w-full h-full object-cover -scale-x-100"></canvas>
                            <div class="scanline"></div>
                            <div class="absolute top-4 left-4 bg-black/70 backdrop-blur-md border border-system-accent/50 px-3 py-1.5 rounded-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-1.5 h-1.5 rounded-full bg-system-danger animate-pulse"></div>
                                    <span class="text-[9px] font-tech text-white uppercase tracking-widest font-bold">Rec_Mode</span>
                                </div>
                                <div id="mode-display" class="text-[11px] font-bold text-system-accent mt-0.5 font-tech tracking-wide uppercase">${gameState.trainingMode} TRACKER</div>
                            </div>
                            <div class="absolute top-4 right-4 bg-system-accent/10 backdrop-blur-md px-4 py-2 rounded-sm border border-system-accent/30 shadow-[0_0_15px_rgba(14,165,233,0.2)]">
                                <div class="text-[8px] font-bold text-system-dim uppercase tracking-widest text-center mb-0.5 font-tech">SESSION</div>
                                <div id="rep-counter" class="text-4xl font-tech font-bold text-white text-center leading-none text-glow">0</div>
                            </div>
                            <div class="absolute bottom-8 left-1/2 -translate-x-1/2 w-full text-center pointer-events-none">
                                <div id="form-feedback" class="inline-block bg-black/80 backdrop-blur-lg border border-system-accent/40 px-6 py-2 rounded-sm text-xs font-bold text-system-accent font-tech uppercase tracking-[0.15em] shadow-xl">
                                    INITIALIZING SENSOR...
                                </div>
                            </div>
                            <div class="absolute top-0 left-0 w-8 h-8 border-l-2 border-t-2 border-system-accent/60"></div>
                            <div class="absolute top-0 right-0 w-8 h-8 border-r-2 border-t-2 border-system-accent/60"></div>
                            <div class="absolute bottom-0 left-0 w-8 h-8 border-l-2 border-b-2 border-system-accent/60"></div>
                            <div class="absolute bottom-0 right-0 w-8 h-8 border-r-2 border-b-2 border-system-accent/60"></div>
                        </div>
                        <div class="mt-8 flex gap-4">
                            <button id="btn-start" onclick="app.startCamera()" class="flex-1 btn-tech py-4 rounded-sm text-sm group overflow-hidden">
                                <span class="relative z-10 flex items-center justify-center gap-2"><i class="fas fa-power-off"></i> Initiate</span>
                                <div class="absolute inset-0 bg-system-accent/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                            </button>
                            <button id="btn-stop" onclick="app.stopCamera()" class="hidden flex-1 btn-tech-danger py-4 rounded-sm text-sm"><i class="fas fa-stop-circle mr-2"></i> Abort</button>
                        </div>
                    </div>
                `;
            },

            // --- Logic ---
            setTrainingMode(mode) {
                gameState.trainingMode = mode;
                this.renderTraining(document.getElementById('app-container'));
                if (this.camera) {
                    this.training.mode = mode;
                    this.training.count = 0;
                    document.getElementById('rep-counter').innerText = 0;
                    document.getElementById('form-feedback').innerText = "MODE SWITCHED";
                }
            },

            getHexGrid() { return [0.25, 0.5, 0.75, 1].map(l => `<polygon points="${this.calculateHexPoints(50, 50, 45*l)}" fill="none" stroke="#38bdf8" stroke-width="0.5" stroke-opacity="${l===1?0.4:0.1}" />`).join(''); },
            getHexAxes() {
                let l=''; for(let i=0;i<6;i++){ const a=(i*60-90)*(Math.PI/180), x=50+45*Math.cos(a), y=50+45*Math.sin(a); l+=`<line x1="50" y1="50" x2="${x}" y2="${y}" stroke="#38bdf8" stroke-width="0.5" stroke-opacity="0.2" />`; } return l;
            },
            getHexPoints(stats, max) {
                const v=[stats.str, stats.vit, stats.luk, stats.int, stats.per, stats.agi].map(s=>Math.min(s,max)/max);
                return v.map((val,i)=>{ const a=(i*60-90)*(Math.PI/180), x=50+(45*val)*Math.cos(a), y=50+(45*val)*Math.sin(a); return `${x},${y}`; }).join(' ');
            },
            getHexDots(stats, max) {
                const v=[stats.str, stats.vit, stats.luk, stats.int, stats.per, stats.agi].map(s=>Math.min(s,max)/max);
                return v.map((val,i)=>{ const a=(i*60-90)*(Math.PI/180), x=50+(45*val)*Math.cos(a), y=50+(45*val)*Math.sin(a); return `<circle cx="${x}" cy="${y}" r="1.5" fill="#38bdf8" />`; }).join('');
            },
            calculateHexPoints(cx, cy, r) {
                let p=[]; for(let i=0;i<6;i++){ const a=(i*60-90)*(Math.PI/180); p.push(`${cx+r*Math.cos(a)},${cy+r*Math.sin(a)}`); } return p.join(' ');
            },

            // --- Camera & AI ---
            video: null, canvas: null, ctx: null, pose: null, camera: null,
            
            async startCamera() {
                const btnStart = document.getElementById('btn-start');
                const btnStop = document.getElementById('btn-stop');
                const feedback = document.getElementById('form-feedback');
                if(btnStart) btnStart.querySelector('span').innerText = "INITIALIZING...";
                
                try {
                    this.video = document.getElementById('video-feed');
                    this.canvas = document.getElementById('pose-canvas');
                    this.ctx = this.canvas.getContext('2d');
                    this.pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
                    this.pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                    this.pose.onResults(this.onPoseResults.bind(this));
                    this.camera = new Camera(this.video, { onFrame: async () => { await this.pose.send({image: this.video}); }, width: 640, height: 480 });
                    await this.camera.start();
                    
                    btnStart.classList.add('hidden');
                    btnStop.classList.remove('hidden');
                    feedback.innerText = "ALIGN BODY IN FRAME";
                    this.training = { active: true, mode: gameState.trainingMode, count: 0, stage: 'start', lastTime: Date.now() };
                } catch (e) {
                    console.error(e);
                    this.showToast("CAMERA ACCESS DENIED", "error");
                    if(btnStart) btnStart.querySelector('span').innerHTML = '<i class="fas fa-power-off"></i> Initiate';
                }
            },

            stopCamera() {
                if (this.camera) { this.camera.stop(); this.camera = null; }
                if (this.video && this.video.srcObject) { this.video.srcObject.getTracks().forEach(t => t.stop()); }
                
                const btnStart = document.getElementById('btn-start');
                const btnStop = document.getElementById('btn-stop');
                if (btnStart) { 
                    btnStart.classList.remove('hidden'); 
                    btnStart.querySelector('span').innerHTML = '<i class="fas fa-power-off"></i> Initiate'; 
                }
                if (btnStop) btnStop.classList.add('hidden');
                
                // Sync first, then reset
                if (this.training.count > 0) {
                    this.syncTrainingProgress(this.training.mode, this.training.count);
                }
                
                // CRITICAL FIX: Reset training state entirely to prevent double counting on navigation
                this.training = { active: false, mode: gameState.trainingMode, count: 0, stage: 'start', lastTime: 0 };
            },

            onPoseResults(results) {
                if (!this.ctx || !this.canvas) return;
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                this.ctx.save();
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.drawImage(results.image, 0, 0, this.canvas.width, this.canvas.height);
                if (results.poseLandmarks) {
                    this.drawSkeleton(results.poseLandmarks);
                    this.analyzePose(results.poseLandmarks);
                }
                this.ctx.restore();
            },

            drawSkeleton(landmarks) {
                drawConnectors(this.ctx, landmarks, POSE_CONNECTIONS, {color: '#0ea5e9', lineWidth: 2});
                drawLandmarks(this.ctx, landmarks, {color: '#e2e8f0', lineWidth: 1, radius: 3});
            },

            analyzePose(landmarks) {
                const mode = gameState.trainingMode;
                const feedback = document.getElementById('form-feedback');
                const counter = document.getElementById('rep-counter');
                
                const lShoulder = landmarks[11], rShoulder = landmarks[12];
                const lElbow = landmarks[13], rElbow = landmarks[14];
                const lWrist = landmarks[15], rWrist = landmarks[16];
                const lHip = landmarks[23], rHip = landmarks[24];
                const lKnee = landmarks[25], rKnee = landmarks[26];
                const lAnkle = landmarks[27], rAnkle = landmarks[28];

                let angle = 0;
                let counted = false;

                if (mode === 'pushup') {
                    angle = this.calculateAngle(lShoulder, lElbow, lWrist);
                    if (angle > 160) { this.training.stage = "up"; feedback.innerText = "DESCEND"; feedback.style.color = "#38bdf8"; }
                    if (angle < 90 && this.training.stage === 'up') { this.training.stage = "down"; counted = true; }
                } 
                else if (mode === 'squat') {
                    angle = this.calculateAngle(lHip, lKnee, lAnkle);
                    if (angle > 170) { this.training.stage = "up"; feedback.innerText = "SQUAT DOWN"; feedback.style.color = "#38bdf8"; }
                    if (angle < 90 && this.training.stage === 'up') { this.training.stage = "down"; counted = true; }
                }
                else if (mode === 'pullup') {
                    if (lWrist.y < lShoulder.y) {
                        angle = this.calculateAngle(lShoulder, lElbow, lWrist);
                        if (angle > 150) { this.training.stage = "hang"; feedback.innerText = "PULL UP"; feedback.style.color = "#38bdf8"; }
                        if (angle < 70 && this.training.stage === 'hang') { this.training.stage = "up"; counted = true; }
                    } else {
                        feedback.innerText = "HANG ON BAR";
                    }
                }
                else if (mode === 'hspu') { 
                    if (lWrist.y > lShoulder.y) {
                        angle = this.calculateAngle(lShoulder, lElbow, lWrist);
                        if (angle > 160) { this.training.stage = "up"; feedback.innerText = "DESCEND"; feedback.style.color = "#38bdf8"; }
                        if (angle < 90 && this.training.stage === 'up') { this.training.stage = "down"; counted = true; }
                    } else {
                        feedback.innerText = "INVERT BODY";
                    }
                }
                else if (mode === 'lunge') {
                    const leftKneeAngle = this.calculateAngle(lHip, lKnee, lAnkle);
                    const rightKneeAngle = this.calculateAngle(rHip, rKnee, rAnkle);
                    if (leftKneeAngle > 160 && rightKneeAngle > 160) { this.training.stage = "up"; feedback.innerText = "LUNGE"; feedback.style.color = "#38bdf8"; }
                    if ((leftKneeAngle < 90 || rightKneeAngle < 90) && this.training.stage === 'up') { this.training.stage = "down"; counted = true; }
                }

                if (counted) {
                    this.training.count++;
                    this.training.lastTime = Date.now();
                    counter.innerText = this.training.count;
                    feedback.innerText = "GOOD FORM";
                    feedback.style.color = "#10b981";
                    this.playSound('success');
                    const flash = document.createElement('div');
                    flash.className = 'absolute inset-0 bg-system-accent/30 pointer-events-none z-50';
                    this.video.parentElement.appendChild(flash);
                    setTimeout(() => flash.remove(), 150);
                    
                    this.syncTrainingProgress(mode, 1);
                }
            },

            calculateAngle(a, b, c) {
                const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
                let angle = Math.abs(radians * 180.0 / Math.PI);
                if (angle > 180.0) angle = 360 - angle;
                return angle;
            },

            syncTrainingProgress(mode, amount) {
                const quest = gameState.quests.find(q => q.mode === mode);
                if (quest && !quest.completed) {
                    quest.current += amount;
                    if(quest.current % 10 === 0 || quest.current >= quest.goal) {
                         this.addLog('TRAIN', `${mode.toUpperCase()} SESSION`, `Verified +${amount} reps. Total: ${quest.current}/${quest.goal}`);
                    }
                    if (quest.current >= quest.goal) {
                        quest.current = quest.goal;
                        this.completeQuest(quest.id);
                    } else {
                        this.saveState();
                    }
                }
            },

            // --- Interactions ---
            manualCompleteQuest(id) {
                this.playSound('click');
                const q = gameState.quests.find(x => x.id === id);
                if(q && !q.completed) {
                    q.current = Math.min(q.goal, q.current + 1);
                    if(q.current >= q.goal) this.completeQuest(id);
                    else this.saveState();
                    this.router('quests');
                }
            },

            completeQuest(id) {
                const q = gameState.quests.find(x => x.id === id);
                if(q && !q.completed) {
                    q.completed = true;
                    this.playSound('levelup');
                    this.showToast(`QUEST CLEARED: ${q.title}`, "success");
                    this.addLog('QUEST', 'QUEST COMPLETE', `Finished: ${q.title}. Reward: +${q.reward} EXP`);
                    
                    if(q.stat) {
                        gameState.player.stats[q.stat] += 3;
                        this.addLog('GROWTH', 'STAT INCREASE', `${q.stat.toUpperCase()} +3`);
                    }

                    this.gainExp(q.reward);
                    this.saveState();
                    this.router('quests');
                }
            },

            gainExp(amount) {
                gameState.player.exp += amount;
                if(gameState.player.exp >= gameState.player.expToNext) this.levelUp();
                this.updateGlobalHUD();
            },

            levelUp() {
                const p = gameState.player;
                p.level++;
                p.exp -= p.expToNext;
                p.expToNext = Math.floor(p.expToNext * 1.5);
                p.statPoints += 3;
                p.hp += 10;
                this.showToast(`LEVEL UP! RANK ${p.rank} -> ${p.level}`, "success");
                this.addLog('LEVEL', 'LEVEL UP', `Rank updated. Current Level: ${gameState.player.level}`);
                const modal = document.getElementById('modal-content');
                const overlay = document.getElementById('modal-overlay');
                modal.innerHTML = `
                    <div class="tech-panel p-8 rounded-lg text-center shadow-[0_0_50px_rgba(14,165,233,0.3)]">
                        <div class="text-5xl text-system-accent mb-6"><i class="fas fa-arrow-circle-up animate-bounce text-glow"></i></div>
                        <h2 class="text-2xl font-tech font-bold text-white mb-2 uppercase tracking-widest text-glow">Level Up!</h2>
                        <p class="text-sm text-gray-400 mb-6 font-medium leading-relaxed">System capacity increased.<br>Current Level: <span class="text-system-accent font-bold">${p.level}</span></p>
                        <button onclick="app.closeModal()" class="btn-tech px-8 py-3 rounded-sm font-bold w-full">Confirm</button>
                    </div>
                `;
                overlay.classList.remove('hidden');
                setTimeout(() => { overlay.classList.remove('opacity-0'); modal.classList.remove('scale-95'); }, 10);
            },

            openStatModal() {
                const p = gameState.player;
                const modal = document.getElementById('modal-content');
                const overlay = document.getElementById('modal-overlay');
                modal.innerHTML = `
                    <div class="tech-panel p-6 rounded-lg max-w-sm w-full">
                        <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-3">
                            <h3 class="font-tech text-system-accent text-sm uppercase tracking-widest font-bold">Stat_Allocation</h3>
                            <span class="text-[10px] font-bold text-white bg-system-accent/10 px-2 py-1 rounded border border-system-accent/30">PTS: ${p.statPoints}</span>
                        </div>
                        <div class="space-y-4">
                            ${Object.keys(p.stats).map(stat => `
                                <div class="flex justify-between items-center group">
                                    <span class="text-xs font-bold text-system-dim uppercase w-8 group-hover:text-white transition-colors font-tech tracking-wider">${stat}</span>
                                    <div class="flex-1 mx-4 h-1.5 bg-gray-900 rounded-full overflow-hidden border border-white/5">
                                        <div class="h-full bg-system-accent rounded-full transition-all duration-300 shadow-[0_0_8px_rgba(14,165,233,0.5)]" style="width: ${(p.stats[stat]/50)*100}%"></div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-sm font-tech text-white w-6 text-right font-bold">${p.stats[stat]}</span>
                                        <button onclick="app.incrementStat('${stat}')" class="w-6 h-6 bg-system-accent/10 hover:bg-system-accent text-system-accent hover:text-white rounded border border-system-accent/30 flex items-center justify-center transition-all ${p.statPoints === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
                                            <i class="fas fa-plus text-[9px]"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="app.closeModal()" class="btn-tech w-full mt-8 py-3 rounded-sm text-[10px]">Close Interface</button>
                    </div>
                `;
                overlay.classList.remove('hidden');
                setTimeout(() => { overlay.classList.remove('opacity-0'); modal.classList.remove('scale-95'); }, 10);
            },

            incrementStat(stat) {
                if (gameState.player.statPoints > 0) {
                    gameState.player.stats[stat]++; gameState.player.statPoints--;
                    this.saveState(); this.updateGlobalHUD(); this.openStatModal();
                }
            },

            closeModal() {
                const modal = document.getElementById('modal-content');
                const overlay = document.getElementById('modal-overlay');
                overlay.classList.add('opacity-0');
                modal.classList.add('scale-95');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            },

            showToast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const styles = { info: 'border-system-accent text-system-accent', success: 'border-system-success text-system-success', danger: 'border-system-danger text-system-danger', error: 'border-system-danger text-system-danger' };
                const icons = { info: 'fa-info-circle', success: 'fa-check-circle', danger: 'fa-exclamation-triangle', error: 'fa-times-circle' };
                el.className = `tech-panel min-w-[260px] border-l-4 p-4 rounded-r-lg flex items-center gap-4 transform transition-all duration-300 translate-y-2 opacity-0 ${styles[type]}`;
                el.innerHTML = `<div class="text-xl"><i class="fas ${icons[type]} text-glow"></i></div><div><div class="text-[9px] font-bold uppercase tracking-widest opacity-70 mb-0.5 font-tech">System Notification</div><div class="text-xs font-bold font-tech tracking-wide text-white">${msg}</div></div>`;
                container.appendChild(el);
                requestAnimationFrame(() => el.classList.remove('translate-y-2', 'opacity-0'));
                setTimeout(() => { el.classList.add('opacity-0', '-translate-y-2'); setTimeout(() => el.remove(), 300); }, 3000);
            },

            playSound(type) {
                if (!this.audioCtx) return;
                const osc = this.audioCtx.createOscillator(), gain = this.audioCtx.createGain();
                osc.connect(gain); gain.connect(this.audioCtx.destination);
                const now = this.audioCtx.currentTime;
                if(type==='click'){osc.frequency.setValueAtTime(800,now);osc.frequency.exponentialRampToValueAtTime(300,now+0.1);gain.gain.setValueAtTime(0.05,now);gain.gain.linearRampToValueAtTime(0,now+0.1);osc.start(now);osc.stop(now+0.1);}
                else if(type==='success'){osc.type='square';osc.frequency.setValueAtTime(440,now);osc.frequency.setValueAtTime(880,now+0.1);gain.gain.setValueAtTime(0.05,now);gain.gain.linearRampToValueAtTime(0,now+0.3);osc.start(now);osc.stop(now+0.3);}
                else if(type==='levelup'){[440,554,659,880].forEach((f,i)=>{const o=this.audioCtx.createOscillator(),g=this.audioCtx.createGain();o.connect(g);g.connect(this.audioCtx.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0.05,now+i*0.1);g.gain.linearRampToValueAtTime(0,now+i*0.1+0.2);o.start(now+i*0.1);o.stop(now+i*0.1+0.2)});}
                else if(type==='magic'){osc.type='sine';osc.frequency.setValueAtTime(200,now);osc.frequency.linearRampToValueAtTime(800,now+0.5);gain.gain.setValueAtTime(0.05,now);gain.gain.linearRampToValueAtTime(0,now+0.5);osc.start(now);osc.stop(now+0.5);}
            },
            
            checkCooldowns() {}
        };

        window.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>